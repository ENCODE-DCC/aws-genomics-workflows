AWSTemplateFormatVersion: "2010-09-09"
Description: >-
  (WWPS-GLS-WF-LT) Creates an EC2 Launch Template for AWS Batch based
  genomics workflows

Mappings:
  TagMap:
    default:
      architecture: "genomics-workflows"
      solution: "default"
      tags:
        - Key: "architecture"
          Value: "genomics-workflows"
        - Key: "solution"
          Value: "default"

Parameters:
  LaunchTemplateNamePrefix:
    Type: String
    Default: genomics-workflow
    Description: Name of the launch template. This will be made unique using the Stack ID.
  DockerStorageVolumeSize:
    Type: Number
    Default: 100
    Description: The initial size of the volume Docker will use for image and metadata storage (GB)
  WorkflowOrchestrator:
    Type: String
    Description: The workflow orchestration engine you will use
    Default: step-functions
    AllowedValues:
      - step-functions
      - cromwell
      - nextflow
  EbsAutoscaleVersion:
    Type: String
    Description: >
      The version of Amazon EBS Autoscale to use. Options are "dist-release" - the version distributed with this release
      of the reference implementation, "latest" - the latest available tagged version from GitHub, "develop" - the current
      master source (recommended for development and advanced use only).
    Default: dist-release
    AllowedValues:
      - dist-release
      - latest
      - develop
  EbsAutoscaleFilesystem:
    Type: String
    Description: >
      The filesystem used by Amazon EBS Autoscale.
    Default: btrfs
    AllowedValues:
      - btrfs
      - lvm.ext4
  ArtifactRootUrl:
    Type: String
    Default: https://s3.amazonaws.com/aws-genomics-workflows/artifacts
    Description: >-
      Root URL for where artifacts / additions scripts are stored

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Required"
        Parameters:
          - WorkflowOrchestrator
          - LaunchTemplateNamePrefix
      - Label:
          default: "Optional"
        Parameters:
          - DockerStorageVolumeSize
          - EbsAutoscaleVersion
          - EbsAutoscaleFilesystem

Resources:
  EC2LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Join ["-", [!Ref LaunchTemplateNamePrefix, !Select [2, !Split ["/", !Ref "AWS::StackId" ]]]]
      LaunchTemplateData:
        TagSpecifications:
          - ResourceType: instance
            Tags:
            - Key: architecture
              Value: !FindInMap ["TagMap", "default", "architecture"]
            - Key: solution
              Value: !Ref WorkflowOrchestrator
        BlockDeviceMappings:
          - Ebs:
              DeleteOnTermination: True
              VolumeSize: 50
              VolumeType: gp2
            DeviceName: /dev/xvda
          - Ebs:
              Encrypted: True
              DeleteOnTermination: True
              VolumeSize: 22
              VolumeType: gp2
            DeviceName: /dev/xvdcz
          - Ebs:
              Encrypted: True
              DeleteOnTermination: True
              VolumeSize: !Ref DockerStorageVolumeSize
              VolumeType: gp2
            DeviceName: /dev/xvdba
        UserData:
          Fn::Base64:
            Fn::Sub: |
              MIME-Version: 1.0
              Content-Type: multipart/mixed; boundary="==BOUNDARY=="

              --==BOUNDARY==
              Content-Type: text/cloud-config; charset="us-ascii"

              packages:
              - jq
              - btrfs-progs
              - sed
              - wget
              - git
              - amazon-ssm-agent
              - unzip

              runcmd:
              # install aws-cli v2 and copy the static binary in an easy to find location for bind-mounts into containers
              - curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
              - unzip -q /tmp/awscliv2.zip -d /tmp
              - /tmp/aws/install
              - mkdir -p /opt/aws-cli/bin
              - cp -R $(dirname $(find /usr/local/aws-cli -name 'aws' -type f)) /opt/aws-cli/bin

              - start amazon-ssm-agent

              - stop ecs
              - service docker stop
              - export EBS_AUTOSCALE_FILESYSTEM="${EbsAutoscaleFilesystem}"
              - cd /opt && wget ${ArtifactRootUrl}/get-amazon-ebs-autoscale.sh
              - sh /opt/get-amazon-ebs-autoscale.sh ${EbsAutoscaleVersion}
              - cd /opt && wget ${ArtifactRootUrl}/aws-ecs-additions.tgz && tar -xzf aws-ecs-additions.tgz
              - sh /opt/ecs-additions/ecs-additions-common.sh
              - sh /opt/ecs-additions/ecs-additions-${WorkflowOrchestrator}.sh
              - service docker start
              - start ecs

              --==BOUNDARY==--

Outputs:
  LaunchTemplateId:
    Description: >-
      EC2 Launch Template ID to use when creating AWS Batch compute environments
      for genomics workflows
    Value: !Ref EC2LaunchTemplate
