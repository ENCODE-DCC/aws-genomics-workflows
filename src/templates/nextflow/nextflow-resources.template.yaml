---
AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  (WWPS-GLS-WF-NEXTFLOW) Creates resources specific to running Nextflow on AWS


Mappings:
  TagMap:
    default:
      architecture: "genomics-workflows"
      solution: "nextflow"
      tags:
        - Key: "architecture"
          Value: "genomics-workflows"
        - Key: "solution"
          Value: "nextflow"


Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Required"
        Parameters:
          - S3BucketName
          - ExistingBucket
          - NextflowContainerImage
      - Label:
          default: "Optional"
        Parameters:
          - S3ConfigPrefix
          - S3ScriptPrefix


Parameters:
  S3BucketName:
    Type: String
    Description: >-
      S3 Bucket used to store nextflow.config and *.nf scripts
  
  S3ConfigPrefix:
    Type: String
    Description: >-
      (Optional) Parent folder in the S3 bucket that contains nextflow.config
  
  S3ScriptPrefix:
    Type: String
    Description: >-
      (Optional) Parent folder in the S3 bucket that contains *.nf workflow scripts
  
  ExistingBucket:
    Type: String
    Description: >-
      Does the S3 Bucket already exist?  If not, it will be created.
    AllowedValues:
      - Yes
      - No
    Default: No
  
  NextflowContainerImage:
    Type: String
    Description: >-
      Container image for nextflow with custom entrypoint for config and workflow
      script staging.  (Example, "<dockerhubuser>/nextflow:latest")


Conditions:
  BucketDoesNotExist:
    Fn::Equals:
      - !Ref ExistingBucket
      - No
  
  NoS3ConfigPrefix:
    Fn::Equals:
      - !Ref S3ConfigPrefix
      - ""
  
  NoS3ScriptPrefix:
    Fn::Equals:
      - !Ref S3ScriptPrefix
      - ""


Resources:
  S3WorkflowConfigBucket:
    Type: AWS::S3::Bucket
    Condition: BucketDoesNotExist
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref S3BucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
             SSEAlgorithm: AES256
      Tags: !FindInMap ["TagMap", "default", "tags"]
  
  IAMNextflowJobRole:
    Type: AWS::IAM::Role
    Properties:
      Policies:
        - PolicyName: !Sub Nextflow-Batch-Access-${AWS::Region}
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Resource: "*"
                Action:
                  - "batch:*"
        - PolicyName: !Sub Nextflow-S3Bucket-Access-${AWS::Region}
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Deny
                Resource: !Join ["", ["arn:aws:s3:::", !Ref S3BucketName]]
                Action:
                  - "s3:Delete*"
                  - "s3:PutBucket*"
              - Effect: Allow
                Resource: !Join ["", ["arn:aws:s3:::", !Ref S3BucketName]]
                Action:
                  - "s3:ListBucket*"
              - Effect: Allow
                Resource: !Join ["", ["arn:aws:s3:::", !Ref S3BucketName, "/*"]]
                Action:
                  - "s3:*"
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "ecs-tasks.amazonaws.com"
            Action:
              - "sts:AssumeRole"

  BatchNextflowJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      Type: container
      Parameters:
        NextflowConfig:
          Fn::Join:
            - "/"
            - - Fn::If:
                  - NoS3ConfigPrefix
                  - !Sub "s3://${S3BucketName}"
                  - !Join ["/", [!Sub "s3://${S3BucketName}", !Ref S3ConfigPrefix]]
              - nextflow.config
        NextflowScript: 
          Fn::Join:
            - "/"
            - - Fn::If:
                  - NoS3ScriptPrefix
                  - !Sub "s3://${S3BucketName}"
                  - !Join ["/", [!Sub "s3://${S3BucketName}", !Ref S3ScriptPrefix]]
              - workflow.nf
      ContainerProperties: 
        MountPoints: 
          - ContainerPath: /opt/work
            SourceVolume: scratch
        Volumes: 
          - Host:
              SourcePath: /scratch
            Name: scratch
        Command: 
          - Ref::NextflowConfig
          - Ref::NextflowScript
        Memory: 1024
        JobRoleArn: !GetAtt IAMNextflowJobRole.Arn
        Vcpus: 2
        Image: !Ref NextflowContainerImage
      JobDefinitionName: nextflow


Outputs:
  BucketName:
    Description: >-
      S3 Bucket used to store nextflow.config and *.nf scripts
    Value:
      Fn::If:
        - BucketDoesNotExist
        - !Ref S3WorkflowConfigBucket
        - !Ref S3BucketName
  
  ConfigPrefix:
    Description: >-
      Path in the S3 bucket where nextflow.config file(s) are located.  If blank,
      then they are located at the root level of the bucket.
    Value: !Ref S3ConfigPrefix
  
  ScriptPrefix:
    Description: >-
      Path in the S3 bucket where *.nf script files are located.  If blank,
      then they are located at the root level of the bucket.
    Value: !Ref S3ConfigPrefix

  NextflowJobDefinition:
    Description: >-
      Batch Job Definition that creates a nextflow head node for running workflows
    Value: !Ref BatchNextflowJobDefinition
  
  NextflowJobRole:
    Description: >-
      IAM Role that allows the nextflow head node job access to S3 and Batch
    Value: !GetAtt IAMNextflowJobRole.Arn