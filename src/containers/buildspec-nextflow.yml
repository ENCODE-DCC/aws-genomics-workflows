# CodeBuild buildspec file for creating container image for nextflow
# assumes the following environment variables:
# - PROJECT_BRANCH: git branch / tag / commit-id to build
# - PROJECT_PATH: path in the source to navigate to prior to build
# - REGISTRY: docker image registry (e.g. ECR) to push the container image to
# - AWS_REGION: (Provided by CodeBuild) region to use for ECR
version: 0.2
phases:
  pre_build:
    commands:
      - git checkout $PROJECT_BRANCH
      - cd $PROJECT_PATH
  build:
    commands:
      - echo "Building container"
      - docker build -t nextflow .
  post_build:
    commands:
      - echo "Tagging container image for ECR"
      - docker tag nextflow:latest ${REGISTRY}/nextflow:latest
      - echo "Docker Login to ECR"
      - $(aws ecr get-login --no-include-email --region ${AWS_REGION})
      - echo "Pushing container image to ECR"
      - docker push ${REGISTRY}/nextflow:latest
