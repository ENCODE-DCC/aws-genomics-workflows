#!/bin/sh

if [ "$#" -eq "0" ]; then
  VG="docker_scratch"
  LV="docker_scratch_pool"
elif [ "$#" -eq "2" ]; then
  VG="$1"
  LV="$2"
else
  echo "USAGE: $0 [<VOLUME GROUP NAME> <LOGICAL VOLUME NAME>]"
  exit
fi

Z=$(curl -s  http://169.254.169.254/latest/meta-data/placement/availability-zone/)
R=$(echo $Z | sed -e 's/[a-z]$//')
I=$(curl -s  http://169.254.169.254/latest/meta-data/instance-id)
# Get the Volume ID.
D=$(pvscan | grep ${VG} | awk '{print $2}')

calc_new_size() {
  local curr_size=$1
  local new_size=$curr_size

  local m=$(echo "scale=0; ( $curr_size / 256 )" | bc -l)
  if [ $m -eq 0 ]; then
    new_size=256
  elif [ $m -ge 16 ]; then
    new_size=$(echo "$curr_size + 2048" | bc -l )
  else
    new_size=$(echo "$curr_size + (256 * $m)" | bc -l )
  fi
  echo $new_size
}

add_space () {
  curr_size=$(df  -BG /dev/${VG}/${LV} | grep ${VG} |awk '{print $2} ' | cut -d'G' -f1)
  if [ $curr_size -lt 16384 ]; then
    new_size=$(calc_new_size $curr_size)
    V=$(aws ec2 --region $R --output text describe-volumes --filters Name=attachment.instance-id,Values=$I,Name=attachment.device,Values=$D --query "Volumes[0].Attachments[0].VolumeId")
    logthis "Extending volume $V ($curr_size -> $new_size)"

    # attach the new EBS volume to this host
    aws ec2 modify-volume --region $R --volume-id $V --size $new_size

    # get free extents in VG
    E=$(vgdisplay ${VG} |grep "Free" | awk '{print $5}')
    # extend the docker LV by the free extents
    lvextend --resizefs --extents +$E /dev/${VG}/${LV}
  fi
}

logthis () {
  echo "[`date`] $1"
}

while true; do
  F=$(df -h  /dev/${VG}/${LV} | grep ${VG} | awk '{print $5}' | cut -d"%" -f1 -)
  if  [ $F -ge "80" ]; then
    logthis "LOW DISK ($F): Adding more."
    add_space
  fi
  sleep 5
done
